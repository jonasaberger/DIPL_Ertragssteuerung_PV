{
  "openapi": "3.0.0",
  "info": {
    "title": "DIPL_Ertragssteuerung_PV API",
    "version": "1.4.0",
    "description": "API for accessing PV, Wallbox, Boiler measurements, EPEX market data, and device configuration"
  },
  "paths": {
    "/connection": {
      "get": {
        "summary": "Check InfluxDB connection",
        "description": "Tests the connection between the backend service and the InfluxDB database.",
        "responses": {
          "200": { "description": "InfluxDB connection successful" },
          "500": { "description": "InfluxDB connection failed" }
        }
      }
    },

    "/api/state": {
      "get": {
        "summary": "System status overview",
        "description": "Returns a compact health status of backend service, InfluxDB connection and connected devices.",
        "tags": ["Monitoring"],
        "responses": { "200": { "description": "Current system status" } }
      }
    },

    "/api/devices/get_devices": {
      "get": {
        "summary": "Get all devices",
        "description": "Returns all device configurations including base URLs and endpoints",
        "tags": ["Configuration"],
        "responses": {
          "200": {
            "description": "All devices returned successfully",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/DeviceConfigResponse" }
              }
            }
          }
        }
      }
    },

    "/api/devices/get_device": {
      "get": {
        "summary": "Get a single device by ID",
        "description": "Returns the configuration for a single device. Requires query parameter 'deviceId'.",
        "tags": ["Configuration"],
        "parameters": [
          {
            "name": "deviceId",
            "in": "query",
            "required": true,
            "description": "Device identifier (pv, wallbox, epex)",
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": { "description": "Device returned successfully", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Device" } } } },
          "400": { "description": "deviceId query parameter missing" },
          "404": { "description": "Device not found" }
        }
      }
    },
    "/api/devices/admin/verify_admin_pw": {
      "post": {
        "summary": "Verify admin password",
        "description": "Checks if the provided password matches the stored admin password hash. Requires JSON body: { 'password': '...' }",
        "tags": ["Admin"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["password"],
                "properties": {
                  "password": { "type": "string", "format": "password" }
                }
              },
              "example": { "password": "meinAdminPw" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Password verified successfully",
            "content": {
              "application/json": { "example": { "verified": true } }
            }
          },
          "400": {
            "description": "Password missing in request body",
            "content": {
              "application/json": { "example": { "error": "Password is required" } }
            }
          },
          "401": {
            "description": "Password incorrect",
            "content": {
              "application/json": { "example": { "verified": false } }
            }
          }
        }
      }
    },


    "/api/pv/latest": { "get": { "summary": "Get latest PV data" } },
    "/api/pv/daily": { "get": { "summary": "Get daily PV data" } },
    "/api/pv/monthly": { "get": { "summary": "Get monthly PV data" } },
    "/api/pv/yearly": { "get": { "summary": "Get yearly PV data" } },

    "/api/wallbox/latest": { "get": { "summary": "Get latest Wallbox data" } },
    "/api/wallbox/setCharging": { "post": { "summary": "Enable or disable wallbox charging" } },

    "/api/boiler/latest": { "get": { "summary": "Get latest Boiler temperature" } },
    "/api/boiler/state": { "get": { "summary": "Get boiler heating state" } },
    "/api/boiler/control": { "post": { "summary": "Control boiler relay" } },

    "/api/epex/latest": { "get": { "summary": "Get latest EPEX data" } }
  },

  "components": {
    "schemas": {
      "DeviceConfigResponse": {
        "type": "object",
        "properties": {
          "pv": { "$ref": "#/components/schemas/Device" },
          "wallbox": { "$ref": "#/components/schemas/Device" },
          "boiler": { "$ref": "#/components/schemas/Device" },
          "epex": { "$ref": "#/components/schemas/Device" },
          "version": { "type": "integer", "example": 1 }
        }
      },
      "Device": {
        "type": "object",
        "properties": {
          "baseUrl": { "type": "string", "format": "uri" },
          "endpoints": {
            "type": "object",
            "additionalProperties": { "type": "string" }
          }
        }
      },

      "PVMeasurement": {
        "type": "object",
        "additionalProperties": true,
        "properties": {
          "_time": { "type": "string", "format": "date-time" },
          "pv_power": { "type": "number" },
          "grid_power": { "type": "number" },
          "load_power": { "type": "number" },
          "battery_power": { "type": "number" },
          "soc": { "type": "number" },
          "e_total": { "type": "number" },
          "rel_autonomy": { "type": "number" },
          "rel_selfconsumption": { "type": "number" }
        }
      },
      "WallboxLatest": { "type": "object", "required": ["_time","amp","car","alw","wst","eto","pha_L1","pha_L2","pha_L3","pha_count","charging"] },
      "BoilerLatest": { "type": "object", "properties": { "_time": { "type": "string", "format": "date-time" }, "boiler_temp": { "type": "number" } } },
      "BoilerControl": { "type": "object", "required": ["action"], "properties": { "action": { "type": "string", "enum": ["on", "off", "toggle"] } } },
      "EpexLatest": { "type": "object", "properties": { "_time": { "type": "string", "format": "date-time" }, "epex_value": { "type": "number" } } }
    }
  }
}
