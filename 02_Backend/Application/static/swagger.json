{
  "openapi": "3.0.0",
  "info": {
    "title": "DIPL_Ertragssteuerung_PV API",
    "version": "1.3.0",
    "description": "API for accessing PV, Wallbox, Boiler measurements, and EPEX market data"
  },
  "paths": {
    "/connection": {
      "get": {
        "summary": "Check InfluxDB connection",
        "description": "Tests the connection between the backend service and the InfluxDB database.",
        "responses": {
          "200": {
            "description": "InfluxDB connection successful",
            "content": {
              "application/json": { "example": { "status": "ok" } }
            }
          },
          "500": {
            "description": "InfluxDB connection failed",
            "content": {
              "application/json": { "example": { "status": "error", "message": "Connection error: Failed to connect to InfluxDB" } }
            }
          }
        }
      }
    },
    "/api/latest": {
      "get": {
        "summary": "Get latest PV data",
        "description": "Returns the most recent PV measurements from InfluxDB.",
        "responses": {
          "200": {
            "description": "Latest PV measurement",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/PVLatest" },
                "example": {
                  "pv_power": 1147.7,
                  "grid_power": -56.5,
                  "load_power": -375.46,
                  "battery_power": -660.34,
                  "soc": 93.9,
                  "e_day": 0,
                  "e_year": 0,
                  "e_total": 20084390.95,
                  "rel_autonomy": 100,
                  "rel_selfconsumption": 86.92,
                  "_time": "2025-10-09T12:34:56Z"
                }
              }
            }
          },
          "404": { "description": "No data found" }
        }
      }
    },
    "/api/history/daily": {
      "get": {
        "summary": "Get 24h PV data",
        "description": "Returns PV measurements from 12:00 of the previous day to 12:00 of the current day. Data points are aggregated over 15-minute intervals using InfluxDB's aggregateWindow function.",
        "responses": {
          "200": {
            "description": "24-hour PV history",
            "content": {
              "application/json": {
                "schema": { "type": "array", "items": { "$ref": "#/components/schemas/PVHistoryItem" } },
                "example": [
                  {
                    "_time": "2025-10-09T12:00:00Z",
                    "pv_power": 1100,
                    "grid_power": -100,
                    "load_power": -350,
                    "battery_power": -700,
                    "soc": 50,
                    "e_day": 5000,
                    "e_year": 150000,
                    "e_total": 20090000,
                    "rel_autonomy": 95,
                    "rel_selfconsumption": 70
                  }
                ]
              }
            }
          },
          "404": { "description": "No daily data found" }
        }
      }
    },
    "/api/history/weekly": {
      "get": {
        "summary": "Get weekly PV data",
        "description": "Returns PV measurements for the last 7 days. Data points are aggregated over 1-hour intervals using InfluxDB's aggregateWindow function.",
        "responses": {
          "200": {
            "description": "Weekly PV history",
            "content": {
              "application/json": {
                "schema": { "type": "array", "items": { "$ref": "#/components/schemas/PVHistoryItem" } },
                "example": [
                  {
                    "_time": "2025-10-03T12:00:00Z",
                    "pv_power": 1050,
                    "grid_power": -120,
                    "load_power": -360,
                    "battery_power": -680,
                    "soc": 52,
                    "e_day": 4800,
                    "e_year": 149500,
                    "e_total": 20080000,
                    "rel_autonomy": 96,
                    "rel_selfconsumption": 72
                  }
                ]
              }
            }
          },
          "404": { "description": "No weekly data found" }
        }
      }
    },
    "/api/wallbox/latest": {
      "get": {
        "summary": "Get latest Wallbox data",
        "description": "Returns the most recent wallbox measurements (read-only, live from the device).",
        "responses": {
          "200": {
            "description": "Latest Wallbox measurement",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/WallboxLatest" },
                "example": {
                  "_time": "2025-10-09T12:35:10Z",
                  "amp": 16,
                  "car": 1,
                  "alw": 1,
                  "wst": 0,
                  "eto": 123456.7,
                  "pha_L1": 1,
                  "pha_L2": 1,
                  "pha_L3": 1,
                  "pha_count": 3,
                  "charging": 1
                }
              }
            }
          },
          "404": { "description": "No wallbox data found" }
        }
      }
    },
    "/api/boiler/latest": {
      "get": {
        "summary": "Get latest Boiler temperature",
        "description": "Returns the most recent boiler temperature measurement from InfluxDB.",
        "responses": {
          "200": {
            "description": "Latest boiler temperature",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/BoilerLatest" },
                "example": {
                  "_time": "2025-11-23T06:15:00Z",
                  "boiler_temp": 62
                }
              }
            }
          },
          "404": { "description": "No boiler data found" }
        }
      }
    },
    "/api/epex/latest": {
      "get": {
        "summary": "Get latest EPEX data",
        "description": "Returns the most recent EPEX market value from InfluxDB.",
        "responses": {
          "200": {
            "description": "Latest EPEX measurement",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/EpexLatest" },
                "example": {
                  "_time": "2025-12-09T12:45:00Z",
                  "epex_value": 42.75
                }
              }
            }
          },
          "404": { "description": "No EPEX data found" },
          "500": {
            "description": "Error querying InfluxDB",
            "content": {
              "application/json": {
                "example": {
                  "status": "error",
                  "message": "Failed to query InfluxDB"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "PVLatest": {
        "type": "object",
        "additionalProperties": true,
        "properties": {
          "_time": { "type": "string", "format": "date-time" },
          "pv_power": { "type": "number" },
          "grid_power": { "type": "number" },
          "load_power": { "type": "number" },
          "battery_power": { "type": "number" },
          "soc": { "type": "number" },
          "e_day": { "type": "number" },
          "e_year": { "type": "number" },
          "e_total": { "type": "number" },
          "rel_autonomy": { "type": "number" },
          "rel_selfconsumption": { "type": "number" }
        }
      },
      "PVHistoryItem": {
        "type": "object",
        "additionalProperties": true,
        "properties": {
          "_time": { "type": "string", "format": "date-time" }
        }
      },
      "WallboxLatest": {
        "type": "object",
        "additionalProperties": true,
        "properties": {
          "_time": { "type": "string", "format": "date-time" },
          "amp": { "type": "number", "description": "Charging current (A)" },
          "car": { "type": "integer", "description": "Car connected (1) / not connected (0)" },
          "alw": { "type": "integer", "description": "Allow charging flag (1 = allowed)" },
          "wst": { "type": "integer", "description": "Wallbox status code" },
          "eto": { "type": "number", "description": "Total charged energy (Wh or kWh depending on source)" },
          "pha_L1": { "type": "number", "description": "Phase L1 active (1/0) or value" },
          "pha_L2": { "type": "number", "description": "Phase L2 active (1/0) or value" },
          "pha_L3": { "type": "number", "description": "Phase L3 active (1/0) or value" },
          "pha_count": { "type": "integer", "description": "Number of active phases (1-3)" },
          "charging": { "type": "integer", "description": "Charging active flag (1 = charging)" }
        }
      },
      "BoilerLatest": {
        "type": "object",
        "additionalProperties": true,
        "properties": {
          "_time": { "type": "string", "format": "date-time" },
          "boiler_temp": { "type": "number", "description": "Boiler temperature in °C" }
        }
      },
      "EpexLatest": {
        "type": "object",
        "additionalProperties": true,
        "properties": {
          "_time": { "type": "string", "format": "date-time" },
          "epex_value": { "type": "number", "description": "Latest EPEX market price in €/MWh" }
        }
      }
    }
  }
}
