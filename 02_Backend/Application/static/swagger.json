{
  "openapi": "3.0.0",
  "info": {
    "title": "DIPL_Ertragssteuerung_PV API",
    "version": "1.3.0",
    "description": "API for accessing PV, Wallbox, Boiler measurements, and EPEX market data"
  },
  "paths": {
    "/connection": {
      "get": {
        "summary": "Check InfluxDB connection",
        "description": "Tests the connection between the backend service and the InfluxDB database.",
        "responses": {
          "200": {
            "description": "InfluxDB connection successful",
            "content": {
              "application/json": {
                "example": {
                  "status": "ok"
                }
              }
            }
          },
          "500": {
            "description": "InfluxDB connection failed",
            "content": {
              "application/json": {
                "example": {
                  "status": "error",
                  "message": "Connection error: Failed to connect to InfluxDB"
                }
              }
            }
          }
        }
      }
    },
    "/api/latest": {
      "get": {
        "summary": "Get latest PV data",
        "description": "Returns the most recent PV measurements from InfluxDB.",
        "responses": {
          "200": {
            "description": "Latest PV measurement",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PVLatest"
                },
                "example": {
                  "pv_power": 1147.7,
                  "grid_power": -56.5,
                  "load_power": -375.46,
                  "battery_power": -660.34,
                  "soc": 93.9,
                  "e_day": 0,
                  "e_year": 0,
                  "e_total": 20084390.95,
                  "rel_autonomy": 100,
                  "rel_selfconsumption": 86.92,
                  "_time": "2025-10-09T12:34:56Z"
                }
              }
            }
          },
          "404": {
            "description": "No data found"
          }
        }
      }
    },
    "/api/history/daily": {
      "get": {
        "summary": "Get 24h PV data",
        "description": "Returns PV measurements from 12:00 of the previous day to 12:00 of the current day. Data points are aggregated over 15-minute intervals using InfluxDB's aggregateWindow function.",
        "responses": {
          "200": {
            "description": "24-hour PV history",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/PVHistoryItem"
                  }
                },
                "example": [
                  {
                    "_time": "2025-10-09T12:00:00Z",
                    "pv_power": 1100,
                    "grid_power": -100,
                    "load_power": -350,
                    "battery_power": -700,
                    "soc": 50,
                    "e_day": 5000,
                    "e_year": 150000,
                    "e_total": 20090000,
                    "rel_autonomy": 95,
                    "rel_selfconsumption": 70
                  }
                ]
              }
            }
          },
          "404": {
            "description": "No daily data found"
          }
        }
      }
    },
    "/api/history/weekly": {
      "get": {
        "summary": "Get weekly PV data",
        "description": "Returns PV measurements for the last 7 days. Data points are aggregated over 1-hour intervals using InfluxDB's aggregateWindow function.",
        "responses": {
          "200": {
            "description": "Weekly PV history",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/PVHistoryItem"
                  }
                },
                "example": [
                  {
                    "_time": "2025-10-03T12:00:00Z",
                    "pv_power": 1050,
                    "grid_power": -120,
                    "load_power": -360,
                    "battery_power": -680,
                    "soc": 52,
                    "e_day": 4800,
                    "e_year": 149500,
                    "e_total": 20080000,
                    "rel_autonomy": 96,
                    "rel_selfconsumption": 72
                  }
                ]
              }
            }
          },
          "404": {
            "description": "No weekly data found"
          }
        }
      }
    },
    "/api/wallbox/latest": {
      "get": {
        "summary": "Get latest Wallbox data",
        "description": "Returns the most recent wallbox measurements (read-only, live from the device).",
        "responses": {
          "200": {
            "description": "Latest Wallbox measurement",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WallboxLatest"
                },
                "example": {
                  "_time": "2025-10-09T12:35:10Z",
                  "amp": 16,
                  "car": 1,
                  "alw": 1,
                  "wst": 0,
                  "eto": 123456.7,
                  "pha_L1": 1,
                  "pha_L2": 1,
                  "pha_L3": 1,
                  "pha_count": 3,
                  "charging": 1
                }
              }
            }
          },
          "404": {
            "description": "No wallbox data found"
          }
        }
      }
    },
    "/api/wallbox/setCharging": {
      "post": {
        "summary": "Enable or disable wallbox charging",
        "description": "Controls wallbox charging permission via the alw flag (allow=true → alw=1, allow=false → alw=0).",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["allow"],
                "properties": {
                  "allow": {
                    "type": "boolean",
                    "description": "true = allow charging, false = stop charging"
                  }
                }
              },
              "example": {
                "allow": true
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Charging state updated",
            "content": {
              "application/json": {
                "example": {
                  "alw": 1
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          },
          "502": {
            "description": "Wallbox communication failed"
          }
        }
      }
    },
    "/api/boiler/latest": {
      "get": {
        "summary": "Get latest Boiler temperature",
        "description": "Returns the most recent boiler temperature measurement from InfluxDB.",
        "responses": {
          "200": {
            "description": "Latest boiler temperature",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BoilerLatest"
                },
                "example": {
                  "_time": "2025-11-23T06:15:00Z",
                  "boiler_temp": 62
                }
              }
            }
          },
          "404": {
            "description": "No boiler data found"
          }
        }
      }
    },
    "/api/boiler/state": {
      "get": {
        "summary": "Get boiler heating state",
        "description": "Returns the logical heating state of the boiler (True = heating ON, False = heating OFF).",
        "responses": {
          "200": {
            "description": "Current boiler heating state",
            "content": {
              "application/json": {
                "example": {
                  "heating": true
                }
              }
            }
          },
          "500": {
            "description": "Error reading boiler state",
            "content": {
              "application/json": {
                "example": {
                  "error": "Failed to read boiler state"
                }
              }
            }
          }
        }
      }
    },
    "/api/boiler/control": {
      "post": {
        "summary": "Control boiler relay (on/off/toggle)",
        "description": "Controls the boiler relay. POST a JSON payload with action set to 'on', 'off' or 'toggle'",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/BoilerControl"
              },
              "example": {
                "action": "on"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Action executed",
            "content": {
              "application/json": {
                "example": {
                  "action": "on",
                  "result": true
                }
              }
            }
          },
          "400": {
            "description": "Invalid action provided",
            "content": {
              "application/json": {
                "example": {
                  "error": "Invalid action. Use: on/off/toggle"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error while controlling boiler",
            "content": {
              "application/json": {
                "example": {
                  "error": "Failed to control boiler"
                }
              }
            }
          }
        }
      }
    },
    "/api/epex/latest": {
      "get": {
        "summary": "Get latest EPEX data",
        "description": "Returns the most recent EPEX market value from InfluxDB.",
        "responses": {
          "200": {
            "description": "Latest EPEX measurement",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EpexLatest"
                },
                "example": {
                  "_time": "2025-12-09T12:45:00Z",
                  "epex_value": 42.75
                }
              }
            }
          },
          "404": {
            "description": "No EPEX data found"
          },
          "500": {
            "description": "Error querying InfluxDB",
            "content": {
              "application/json": {
                "example": {
                  "status": "error",
                  "message": "Failed to query InfluxDB"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "PVLatest": {
        "type": "object",
        "additionalProperties": true,
        "properties": {
          "_time": {
            "type": "string",
            "format": "date-time"
          },
          "pv_power": {
            "type": "number"
          },
          "grid_power": {
            "type": "number"
          },
          "load_power": {
            "type": "number"
          },
          "battery_power": {
            "type": "number"
          },
          "soc": {
            "type": "number"
          },
          "e_day": {
            "type": "number"
          },
          "e_year": {
            "type": "number"
          },
          "e_total": {
            "type": "number"
          },
          "rel_autonomy": {
            "type": "number"
          },
          "rel_selfconsumption": {
            "type": "number"
          }
        }
      },
      "PVHistoryItem": {
        "type": "object",
        "additionalProperties": true,
        "properties": {
          "_time": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
     "WallboxLatest": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "_time",
          "amp",
          "car",
          "alw",
          "wst",
          "eto",
          "pha_L1",
          "pha_L2",
          "pha_L3",
          "pha_count",
          "charging"
        ],
        "properties": {
          "_time": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp of live wallbox snapshot (Europe/Vienna timezone)"
          },
          "amp": {
            "type": "integer",
            "description": "Charging current in ampere"
          },
          "car": {
            "type": "integer",
            "enum": [0, 1],
            "description": "Car connected flag"
          },
          "alw": {
            "type": "integer",
            "enum": [0, 1],
            "description": "Charging allowed flag"
          },
          "wst": {
            "type": "integer",
            "description": "Wallbox internal status code"
          },
          "eto": {
            "type": "number",
            "description": "Total charged energy in Wh"
          },
          "pha_L1": {
            "type": "integer",
            "enum": [0, 1],
            "description": "Phase L1 active"
          },
          "pha_L2": {
            "type": "integer",
            "enum": [0, 1],
            "description": "Phase L2 active"
          },
          "pha_L3": {
            "type": "integer",
            "enum": [0, 1],
            "description": "Phase L3 active"
          },
          "pha_count": {
            "type": "integer",
            "minimum": 0,
            "maximum": 3,
            "description": "Number of active phases"
          },
          "charging": {
            "type": "integer",
            "enum": [0, 1],
            "description": "Charging active flag"
          }
        }
      },
      "BoilerLatest": {
        "type": "object",
        "additionalProperties": true,
        "properties": {
          "_time": {
            "type": "string",
            "format": "date-time"
          },
          "boiler_temp": {
            "type": "number",
            "description": "Boiler temperature in °C"
          }
        }
      },
      "BoilerControl": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "action": {
            "type": "string",
            "description": "Action to perform",
            "enum": [
              "on",
              "off",
              "toggle"
            ]
          }
        },
        "required": [
          "action"
        ]
      },
      "EpexLatest": {
        "type": "object",
        "additionalProperties": true,
        "properties": {
          "_time": {
            "type": "string",
            "format": "date-time"
          },
          "epex_value": {
            "type": "number",
            "description": "Latest EPEX market price in €/MWh"
          }
        }
      }
    }
  }
}
