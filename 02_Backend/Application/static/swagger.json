{
  "openapi": "3.0.0",
  "info": {
    "title": "DIPL_Ertragssteuerung_PV API",
    "version": "1.3.0",
    "description": "API for accessing PV, Wallbox, Boiler measurements, and EPEX market data"
  },
  "paths": {
    "/connection": {
      "get": {
        "summary": "Check InfluxDB connection",
        "description": "Tests the connection between the backend service and the InfluxDB database.",
        "responses": {
          "200": {
            "description": "InfluxDB connection successful",
            "content": {
              "application/json": {
                "example": { "status": "ok" }
              }
            }
          },
          "500": {
            "description": "InfluxDB connection failed",
            "content": {
              "application/json": {
                "example": {
                  "status": "error",
                  "message": "Connection error: Failed to connect to InfluxDB"
                }
              }
            }
          }
        }
      }
    },

    "/api/state": {
      "get": {
        "summary": "System status overview",
        "description": "Returns a compact health status of backend service, InfluxDB connection and connected devices. This endpoint is read-only and intended purely for monitoring.",
        "tags": ["Monitoring"],
        "responses": {
          "200": {
            "description": "Current system status",
            "content": {
              "application/json": {
                "example": {
                  "backend": "ok",
                  "influx": "ok",
                  "wallbox": "timeout",
                  "boiler": "simulated",
                  "timestamp": "2025-12-30T23:15:12"
                }
              }
            }
          }
        }
      }
    },
    "/api/logging": {
      "get": {
        "summary": "Query system logs",
        "description": "Returns filtered log entries from the logging database (monthly). Intended for diagnostics and monitoring only.",
        "tags": ["Logging"],
        "parameters": [
          {
            "name": "type",
            "in": "query",
            "required": true,
            "description": "Type of log entries to query",
            "schema": {
              "type": "string",
              "enum": [
                "system_event",
                "api_error",
                "control_decision",
                "device_state_change"
              ]
            }
          },
          {
            "name": "limit",
            "in": "query",
            "required": false,
            "description": "Maximum number of log entries to return",
            "schema": {
              "type": "integer",
              "default": 50
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Filtered log entries",
            "content": {
              "application/json": {
                "example": [
                  {
                    "_time": "2025-12-30T23:24:10+01:00",
                    "_measurement": "api_error",
                    "api": "wallbox",
                    "endpoint": "/api/wallbox/latest",
                    "error": "Connection timeout"
                  }
                ]
              }
            }
          },
          "400": {
            "description": "Invalid or missing query parameters"
          },
          "500": {
            "description": "Logging query failed"
          }
        }
      }
    },

    "/api/pv/latest": {
      "get": {
        "summary": "Get latest PV data",
        "description": "Returns the most recent PV measurements from InfluxDB.",
        "responses": {
          "200": {
            "description": "Latest PV measurement",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PVMeasurement"
                }
              }
            }
          },
          "404": { "description": "No data found" }
        }
      }
    },

    "/api/pv/daily": {
      "get": {
        "summary": "Get daily PV data",
        "parameters": [
          {
            "name": "date",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "example": "2025-12-24"
            }
          }
        ],
        "responses": {
          "200": { "description": "Daily PV time series" },
          "404": { "description": "No daily data found" }
        }
      }
    },

    "/api/pv/monthly": {
      "get": {
        "summary": "Get monthly PV data",
        "parameters": [
          {
            "name": "month",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "example": "2025-11"
            }
          }
        ],
        "responses": {
          "200": { "description": "Monthly PV time series" },
          "404": { "description": "No monthly data found" }
        }
      }
    },

    "/api/pv/yearly": {
      "get": {
        "summary": "Get yearly PV data",
        "parameters": [
          {
            "name": "year",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "example": 2024
            }
          }
        ],
        "responses": {
          "200": { "description": "Yearly PV time series" },
          "404": { "description": "No yearly data found" }
        }
      }
    },

    "/api/wallbox/latest": {
      "get": {
        "summary": "Get latest Wallbox data",
        "responses": {
          "200": { "description": "Latest Wallbox measurement" },
          "404": { "description": "No wallbox data found" },
          "502": { "description": "Wallbox not reachable" }
        }
      }
    },

    "/api/wallbox/setCharging": {
      "post": {
        "summary": "Enable or disable wallbox charging",
        "responses": {
          "200": { "description": "Charging state updated successfully" },
          "400": { "description": "Invalid input payload" },
          "502": { "description": "Wallbox communication failed" }
        }
      }
    },

    "/api/boiler/latest": {
      "get": {
        "summary": "Get latest Boiler temperature",
        "responses": {
          "200": { "description": "Latest boiler temperature" },
          "404": { "description": "No boiler data found" }
        }
      }
    },

    "/api/boiler/state": {
      "get": {
        "summary": "Get boiler heating state",
        "responses": {
          "200": { "description": "Current boiler heating state" },
          "500": { "description": "Failed to read boiler state" }
        }
      }
    },

    "/api/boiler/control": {
      "post": {
        "summary": "Control boiler relay",
        "responses": {
          "200": { "description": "Boiler control action executed successfully" },
          "400": { "description": "Invalid control action" },
          "500": { "description": "Boiler control failed" }
        }
      }
    },

    "/api/epex/latest": {
      "get": {
        "summary": "Get latest EPEX data",
        "responses": {
          "200": { "description": "Latest EPEX market price" },
          "404": { "description": "No EPEX data found" }
        }
      }
    }
  },

  "components": {
    "schemas": {
      "PVMeasurement": {
        "type": "object",
        "additionalProperties": true,
        "properties": {
          "_time": { "type": "string", "format": "date-time" },
          "pv_power": { "type": "number" },
          "grid_power": { "type": "number" },
          "load_power": { "type": "number" },
          "battery_power": { "type": "number" },
          "soc": { "type": "number" },
          "e_total": { "type": "number" },
          "rel_autonomy": { "type": "number" },
          "rel_selfconsumption": { "type": "number" }
        }
      },

      "WallboxLatest": {
        "type": "object",
        "required": ["_time","amp","car","alw","wst","eto","pha_L1","pha_L2","pha_L3","pha_count","charging"],
        "properties": {
          "_time": { "type": "string", "format": "date-time" },
          "amp": { "type": "integer" },
          "car": { "type": "integer" },
          "alw": { "type": "integer" },
          "wst": { "type": "integer" },
          "eto": { "type": "number" },
          "pha_L1": { "type": "integer" },
          "pha_L2": { "type": "integer" },
          "pha_L3": { "type": "integer" },
          "pha_count": { "type": "integer" },
          "charging": { "type": "integer" }
        }
      },

      "BoilerLatest": {
        "type": "object",
        "properties": {
          "_time": { "type": "string", "format": "date-time" },
          "boiler_temp": { "type": "number" }
        }
      },

      "BoilerControl": {
        "type": "object",
        "required": ["action"],
        "properties": {
          "action": {
            "type": "string",
            "enum": ["on", "off", "toggle"]
          }
        }
      },

      "EpexLatest": {
        "type": "object",
        "properties": {
          "_time": { "type": "string", "format": "date-time" },
          "epex_value": { "type": "number" }
        }
      }
    }
  }
}
